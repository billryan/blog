language: generic

sudo: false

env:
  global:
  - HUGO_VERSION=0.46

before_install:
  # Install Hugo
  - mkdir -p bin
  - curl -L https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_Linux-64bit.tar.gz -o bin/hugo.tar.gz
  - tar xzvvf bin/hugo.tar.gz -C ./bin

script:
  - "./bin/hugo"

before_deploy:
  - git tag "$(date +'%Y%m%d_%H%M%S')-$(git log --format=%h -1)"
  - tar cjvf public.tar.bz2 public/

after_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name "travis"
  - git config --local user.email "travis@github"
  - cp public /tmp/public -r
  - cd /tmp/public
  - git init
  - git add .
  - git commit -m "Travis CI build at `date +"%Y-%m-%d %H:%M"`"
  # Coding Pages
  - git push --force --quiet "https://${CODING_USERNAME}:${CODING_TOKEN}@${CODING_URL}" master:master

deploy:
  - provider: pages
    skip-cleanup: true
    github-token:
      secure: QU4B9CIPUdelYJKnS72SUjOY/9/w9+m536RX8Ex4PsKYMJHEIW7rkbP16ZAvMDoqiQkfPwpQSE8tFOBxMmkgGIgWY86o0xr022ak0iGICFCkjedEfNkKBENjOA8JoMlCx+QRyGcRJKuHBAy8WQU+PKykJDzJzadGNs0ud/+P75k=
    keep-history: true
    local-dir: public
    on:
      branch: master
    target-branch: gh-pages
  - provider: releases
    api_key:
      secure: QU4B9CIPUdelYJKnS72SUjOY/9/w9+m536RX8Ex4PsKYMJHEIW7rkbP16ZAvMDoqiQkfPwpQSE8tFOBxMmkgGIgWY86o0xr022ak0iGICFCkjedEfNkKBENjOA8JoMlCx+QRyGcRJKuHBAy8WQU+PKykJDzJzadGNs0ud/+P75k=
    file: public.tar.bz2
    skip_cleanup: true
    on:
      branch: master

# whitelist
branches:
  only:
    - master
